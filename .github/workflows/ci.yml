name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Odin
        run: |
          git clone https://github.com/odin-lang/Odin.git
          cd Odin
          make release
          sudo cp odin /usr/local/bin/
          cd ..

      - name: Verify Odin Installation
        run: odin version

      - name: Build Linux Binary (Static)
        run: |
          odin build . -out:organize -o:speed -no-bounds-check -disable-assert
          chmod +x organize

      - name: Test Binary
        run: |
          ./organize --help
          echo "âœ“ Binary works!"

      - name: Upload Linux Binary
        uses: actions/upload-artifact@v4
        with:
          name: organize-linux-x64
          path: organize

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Odin
        shell: cmd
        run: |
          git clone https://github.com/odin-lang/Odin.git
          cd Odin
          call build.bat release
          echo %CD%>> %GITHUB_PATH%

      - name: Verify Odin Installation
        shell: cmd
        run: |
          cd Odin
          odin.exe version

      - name: Build Windows Binary (Static)
        shell: cmd
        run: |
          Odin\odin.exe build . -out:organize.exe -o:speed -no-bounds-check -disable-assert

      - name: Test Binary
        shell: cmd
        run: |
          organize.exe --help
          echo Binary works!

      - name: Upload Windows Binary
        uses: actions/upload-artifact@v4
        with:
          name: organize-windows-x64
          path: organize.exe

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release Packages
        run: |
          mkdir -p release

          # Linux package
          mkdir -p linux-package
          cp organize-linux-x64/organize linux-package/
          cp README.md linux-package/
          cp LICENSE linux-package/
          echo "#!/bin/bash" > linux-package/install.sh
          echo "sudo cp organize /usr/local/bin/" >> linux-package/install.sh
          echo "echo 'File Organizer installed successfully!'" >> linux-package/install.sh
          chmod +x linux-package/install.sh
          tar -czf release/file-organizer-linux-x64.tar.gz -C linux-package .

          # Windows package
          mkdir -p windows-package
          cp organize-windows-x64/organize.exe windows-package/
          cp README.md windows-package/
          cp LICENSE windows-package/

          # Create Windows batch launcher
          cat > windows-package/organize.bat << 'EOF'
          @echo off
          if "%~1"=="" (
              echo File Organizer v2.0
              echo.
              echo Usage: organize.bat [directory] [options]
              echo   or drag and drop a folder onto this batch file
              echo.
              echo Examples:
              echo   organize.bat C:\Users\%USERNAME%\Downloads
              echo   organize.bat %USERPROFILE%\Desktop --dry-run
              echo.
              pause
              exit /b
          )
          organize.exe %*
          EOF

          # Create Windows PowerShell script
          cat > windows-package/organize.ps1 << 'EOF'
          param(
              [string]$Directory,
              [switch]$DryRun,
              [switch]$Recursive,
              [switch]$Stats,
              [switch]$Help
          )

          if ($Help -or !$Directory) {
              Write-Host "File Organizer v2.0" -ForegroundColor Cyan
              Write-Host ""
              Write-Host "Usage: .\organize.ps1 -Directory <path> [options]"
              Write-Host ""
              Write-Host "Options:"
              Write-Host "  -DryRun       Preview without moving files"
              Write-Host "  -Recursive    Scan subdirectories"
              Write-Host "  -Stats        Show detailed statistics"
              Write-Host ""
              Write-Host "Examples:"
              Write-Host "  .\organize.ps1 -Directory C:\Users\$env:USERNAME\Downloads"
              Write-Host "  .\organize.ps1 -Directory C:\Temp -DryRun -Stats"
              exit
          }

          $args = @($Directory)
          if ($DryRun) { $args += "--dry-run" }
          if ($Recursive) { $args += "--recursive" }
          if ($Stats) { $args += "--stats" }

          & ".\organize.exe" @args
          EOF

          # Create Windows README
          cat > windows-package/README-WINDOWS.txt << 'EOF'
          File Organizer v2.0 - Windows Edition
          ======================================

          QUICK START:
          ------------
          1. Method 1: Drag & Drop
             - Drag a folder onto "organize.bat"

          2. Method 2: Command Prompt
             - Open Command Prompt in this folder
             - Run: organize.exe C:\path\to\folder

          3. Method 3: PowerShell (Interactive)
             - Right-click "organize.ps1" â†’ "Run with PowerShell"
             - Or: .\organize.ps1 -Directory C:\path\to\folder

          NO INSTALLATION NEEDED!
          -----------------------
          This is a standalone executable. No dependencies required.
          Just extract and run!

          USAGE EXAMPLES:
          ---------------
          # Preview changes (no files moved):
          organize.exe C:\Users\YourName\Downloads --dry-run

          # Organize with statistics:
          organize.exe C:\Users\YourName\Desktop --stats

          # Recursive organization:
          organize.exe C:\Users\YourName\Documents --recursive

          # Find duplicates:
          organize.exe C:\Pictures --duplicates

          For full documentation, see README.md

          TROUBLESHOOTING:
          ----------------
          If Windows Defender blocks the file:
          1. Click "More info"
          2. Click "Run anyway"

          This is normal for new executables. The program is safe!
          EOF

          zip -r release/file-organizer-windows-x64.zip windows-package/

          # Generate checksums
          cd release
          sha256sum * > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body: |
            ## ğŸ“ File Organizer v2.0

            A fast, standalone file organization tool with no dependencies required!

            ### ğŸ“¥ Downloads

            | Platform | File | Description |
            |----------|------|-------------|
            | ğŸ§ **Linux** | `file-organizer-linux-x64.tar.gz` | Standalone binary for Linux x64 |
            | ğŸªŸ **Windows** | `file-organizer-windows-x64.zip` | Standalone executable for Windows x64 |

            ### âœ¨ Features

            - âœ… **No installation needed** - Just download and run!
            - âœ… **No dependencies** - Completely standalone
            - âœ… Automatic file categorization
            - âœ… Duplicate detection and removal
            - âœ… Recursive directory scanning
            - âœ… Progress indicators and statistics
            - âœ… Undo functionality
            - âœ… Interactive mode

            ### ğŸš€ Quick Start

            **Linux:**
            ```bash
            tar -xzf file-organizer-linux-x64.tar.gz
            cd linux-package
            chmod +x organize
            ./organize ~/Downloads --dry-run

            # Optional: Install system-wide
            sudo ./install.sh
            ```

            **Windows:**
            1. Extract `file-organizer-windows-x64.zip`
            2. Choose your preferred method:
               - **Drag & Drop**: Drag a folder onto `organize.bat`
               - **PowerShell**: Right-click `organize.ps1` â†’ "Run with PowerShell"
               - **Command Line**: `organize.exe C:\path\to\folder`

            See `README.md` for full documentation.

            ### ğŸ”’ Security Note

            Windows may show a warning for new executables. This is normal.
            Click "More info" â†’ "Run anyway" to proceed.

            ### ğŸ“Š Checksums

            See `checksums.txt` for SHA256 verification.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
